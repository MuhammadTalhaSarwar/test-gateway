"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.processTimeouts=exports.refreshTimeouts=exports.invokeToTheLimit=exports.ratelimit=void 0;var common_1=require("../common"),limiter_1=require("../limiter");function invokeToTheLimit(e,o){for(var t;e.length>0&&o.isAllowed();)o.decrease(),null===(t=e.shift())||void 0===t||t.complete()}function refreshTimeouts(e,o,t){return setTimeout((function(){return t(e,o)}),o.getNextDelay())}function processTimeouts(e,o,t){return e.length>0?refreshTimeouts(e,o,t):void 0}exports.ratelimit=(0,common_1.adapter)((function(e,o){var t,i=o.delay,r=o.limit,n=o.context,m=o.rejectOnCancel,s=o.limiter||new limiter_1.Limiter((0,common_1.normalizeDelay)(r||i)),c=[],u=function(e,o){(0,common_1.dropTimeout)(t),o.reset(),invokeToTheLimit(e,o),t=processTimeouts(e,o,u)},l=function(){for(var o=[],t=0;t<arguments.length;t++)o[t]=arguments[t];return new Promise((function(t,i){c.push({complete:common_1.complete.bind(void 0,t,e,o,n),fail:common_1.failOnCancel.bind(void 0,i)}),u(c,s)}))};return l.flush=function(){c.forEach((function(e){return e.complete()})),l.cancel()},l.cancel=function(){m&&c.forEach((function(e){return e.fail()})),c.length=0,(0,common_1.dropTimeout)(t)},l})),exports.invokeToTheLimit=invokeToTheLimit,exports.refreshTimeouts=refreshTimeouts,exports.processTimeouts=processTimeouts;